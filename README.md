# 個人向け Sora2 動画再生 MVP 要件定義

## 1. 概要
- Sora 2 / Sora 2 Pro の Videos API で生成した動画を、個人がブラウザから安全に生成・取得・再生できる最小限の Web アプリ。
- 「生成する → 進捗を見る → 再生する」の一連の体験を壊さないことを最優先とし、将来的な拡張も見据えた構成にする。

## 2. 目的
1. OpenAI Videos API を用いた動画生成プロセスをフロントから操作できること。
2. 生成済み動画の一覧とメタデータを管理し、ブラウザで再生できること。
3. API キーを安全に扱い、個人利用の範囲で体験を完結させること。

## 3. 想定ユーザーと利用シナリオ
- **ユーザー**: アプリの所有者本人（単一アカウント）。
- **利用シナリオ**:
  1. ブラウザでプロンプトやパラメータを入力して動画生成ジョブを開始。
  2. バックエンドが OpenAI の `v1/videos` にジョブを登録し、進行状況を定期的に取得。
  3. 完了後に動画コンテンツをサーバ経由で取得し、ブラウザで再生。
  4. 必要に応じてローカルへダウンロード。

## 4. スコープ（MVPで必須）
1. **動画生成フォーム**
   - 入力項目: プロンプト、モデル選択（`sora-2` / `sora-2-pro`）、解像度（例: 720p/1080p）、秒数、アスペクト比、任意のシード値。
   - 生成ボタン、進捗メッセージまたはバー表示。
2. **動画一覧画面**
   - サムネイル、生成日時、ステータス、利用モデル、推定コストなどをカード表示。
   - 新しい順ソートをデフォルトとする。
3. **動画再生画面**
   - `<video controls>` による再生。
   - ダウンロードボタンとメタデータ表示（プロンプト、パラメータ、生成日時など）。
4. **バックエンド API**
   - 生成ジョブ作成、ステータス取得、コンテンツ取得のためのプロキシエンドポイント。
   - OpenAI API への通信とレスポンスストリーミングをサーバ側で実装。
5. **設定・認証**
   - OpenAI API キーはサーバ環境変数から読み込み。フロントエンドには露出しない。
   - 管理用途のシンプルな設定画面（API キーがセットされているか確認できる程度）。

## 5. 非スコープ（MVPでは実施しない）
- マルチユーザー対応やアクセス共有機能。
- 外部公開リンク、SNS 連携。
- 動画編集（トリミング、字幕、フィルタなど）。
- モバイルアプリやネイティブクライアント。
- DRM や課金機能。

## 6. 画面要件（UI概要）
| 画面 | 主な要素 | 補足 |
| --- | --- | --- |
| 生成フォーム | 入力フォーム、生成ボタン、進捗表示 | シンプルなレイアウト。フォーム検証を最低限実施。 |
| 動画一覧 | カード型リスト、サムネイル、ステータス、作成日時 | ステータス別のフィルタは将来拡張とする。 |
| 再生画面 | 大サイズの `<video>` プレーヤー、メタ情報、ダウンロードボタン | シークバーの操作に対応できるよう Range リクエストにも備える。 |

## 7. 機能要件
### 7.1 フロントエンド
- SPA（React / Vue / Svelte など任意）で構築。最新 Chrome / Edge / Safari を対象とする。
- 動画プレーヤーは HTML5 `<video>` を利用し、MIME タイプ `video/mp4` を想定。
- ステータス更新は 5 秒間隔のポーリング。長時間処理に備えて中断・再開操作を用意。
- 生成フォームの入力値検証（最大長、利用可能な解像度など）。
- エラー表示とリトライ導線（ステータス取得失敗時の再試行ボタンなど）。

### 7.2 バックエンド
- 推奨エンドポイント:
  - `POST /api/videos`: 動画生成ジョブを作成し、自前 ID を発行。
  - `GET /api/videos/:id/status`: OpenAI Videos API を参照して進捗・状態を返却。
  - `GET /api/videos/:id/content`: OpenAI のコンテンツエンドポイントへサーバからアクセスし、動画バイナリをストリーミング返却。
- API キーはバックエンドの環境変数で管理。リクエストごとにヘッダへ挿入。
- 生成パラメータのバリデーション（秒数・解像度の上限、禁止ワードチェックなど）。
- レートリミットまたはキューレングスの簡易監視（暴走対策）。
- Range リクエスト (`206 Partial Content`) へ対応し、ブラウザのシーク操作をサポート。

## 8. データモデル（例）
`Video`
- `id`: UUID（自前 ID）。
- `provider_video_id`: OpenAI の動画 ID。
- `status`: `queued` / `processing` / `completed` / `failed`。
- `model`: `sora-2` など使用モデル名。
- `prompt`: 生成プロンプト。
- `duration_seconds`: 生成秒数。
- `resolution`: 例 `1920x1080`。
- `cost_estimate_usd`: コスト目安（任意）。
- `created_at`, `updated_at`。
- `metadata`: JSON（アスペクト比、シードなど）。

## 9. API 契約イメージ
- **生成開始**
  - リクエスト: `POST /api/videos`
  - ボディ: `prompt`, `model`, `durationSeconds`, `resolution`, `seed` 等。
  - レスポンス: `{ "videoId": string }`
- **ステータス取得**
  - リクエスト: `GET /api/videos/:id/status`
  - レスポンス: `{ "status": string, "progress": number, "errorMessage?": string }`
- **動画取得**
  - リクエスト: `GET /api/videos/:id/content`
  - レスポンス: `video/mp4` バイナリストリーム。Range リクエスト対応。

## 10. 非機能要件
- **性能**: 生成完了後、再生開始まで 10 秒以内を目標とする（回線状況に依存）。
- **可用性**: 単一リージョンで構築。停止した場合は手動で再起動する前提。
- **セキュリティ**: API キーの秘匿、CORS の適切な設定、HTTPS 通信。
- **ロギング**: リクエスト/レスポンス、エラー、OpenAI 側の課金情報を記録。
- **ストレージ**: MVP では動画を保存せずストリーミング転送のみ。将来 S3 等へ保存する拡張余地を残す。

## 11. リスクと緩和策
| リスク | 内容 | 緩和策 |
| --- | --- | --- |
| 生成コストの高騰 | 高解像度・長尺の生成で課金が膨らむ | フォームで上限を設定し、警告表示。 |
| 生成待ち時間の長さ | レンダリング待ちが長くなる | ポーリング間隔を調整し、再試行ボタンを用意。 |
| ネットワーク切断 | 取得中に接続が途切れる | 再取得機能、失敗時の明示的なエラー表示。 |
| ブラウザ互換性 | 特に iOS Safari で自動再生制限 | 手動再生前提の UI、互換性テスト。 |

## 12. 開発ロードマップ（推奨順）
1. バックエンドで `POST /api/videos` と `GET /api/videos/:id/content` をダミー実装し、フロントと接続。
2. フロントで生成フォーム → 一覧 → 再生の画面遷移を構築。
3. OpenAI Videos API との実接続に置き換え、ステータス取得をポーリングで実装。
4. エラーハンドリングや入力バリデーション、ログ出力を整備。
5. デザイン・UI を最小限整え、ダウンロードやメタ表示を追加。

---
この要件定義を起点に、API の仕様変更やモデル追加に合わせてアップデートしていくことを推奨する。
